#!/bin/sh

# =============================================================================
# PRE-COMMIT HOOK
# Runs security checks before allowing commits
# =============================================================================

echo "üîí Running pre-commit security checks..."

# -----------------------------------------------------------------------------
# 1. LINT-STAGED (Format and lint changed files)
# -----------------------------------------------------------------------------
echo "üìù Running lint-staged..."
npx lint-staged || {
  echo "‚ùå Lint-staged failed. Please fix the issues above."
  exit 1
}

# -----------------------------------------------------------------------------
# 2. GITLEAKS - Secret Detection (if installed)
# -----------------------------------------------------------------------------
if command -v gitleaks &> /dev/null; then
  echo "üîê Running Gitleaks secret scan..."
  gitleaks protect --staged --redact --verbose 2>&1 | head -50
  if [ ${PIPESTATUS[0]} -ne 0 ]; then
    echo ""
    echo "‚ùå Gitleaks detected potential secrets in staged files!"
    echo "   Please remove secrets before committing."
    echo ""
    echo "   If this is a false positive, you can:"
    echo "   1. Add to .gitleaksignore file"
    echo "   2. Use 'gitleaks:allow' comment in code"
    echo "   3. Bypass with: git commit --no-verify (not recommended)"
    exit 1
  fi
  echo "‚úÖ No secrets detected by Gitleaks"
else
  echo "‚ö†Ô∏è  Gitleaks not installed. Running pattern-based secret detection..."
  # Fall back to pattern-based detection
fi

# -----------------------------------------------------------------------------
# 3. PATTERN-BASED SECRET DETECTION (Fallback/Additional)
# -----------------------------------------------------------------------------
echo "üîç Checking for potential hardcoded secrets..."

# Patterns to detect potential secrets
SECRET_PATTERNS=(
  # API Keys and tokens (generic patterns)
  'api[_-]?key\s*[:=]\s*["\047][A-Za-z0-9_\-]{16,}["\047]'
  'api[_-]?secret\s*[:=]\s*["\047][A-Za-z0-9_\-]{16,}["\047]'
  'access[_-]?token\s*[:=]\s*["\047][A-Za-z0-9_\-]{16,}["\047]'
  'auth[_-]?token\s*[:=]\s*["\047][A-Za-z0-9_\-]{16,}["\047]'
  'bearer\s+[A-Za-z0-9_\-\.]{20,}'
  
  # AWS
  'AKIA[0-9A-Z]{16}'
  'aws[_-]?secret[_-]?access[_-]?key\s*[:=]\s*["\047][A-Za-z0-9/+=]{40}["\047]'
  
  # Private keys
  '-----BEGIN\s+(RSA\s+)?PRIVATE\s+KEY-----'
  '-----BEGIN\s+OPENSSH\s+PRIVATE\s+KEY-----'
  '-----BEGIN\s+EC\s+PRIVATE\s+KEY-----'
  
  # Passwords (avoid empty strings and placeholders)
  'password\s*[:=]\s*["\047][^"\047\$\{]{8,}["\047]'
  'passwd\s*[:=]\s*["\047][^"\047\$\{]{8,}["\047]'
  
  # Database connection strings
  'mongodb(\+srv)?://[^"\047\s]+'
  'postgres(ql)?://[^"\047\s]+'
  'mysql://[^"\047\s]+'
  'redis://[^"\047\s]+'
  
  # JWT secrets
  'jwt[_-]?secret\s*[:=]\s*["\047][A-Za-z0-9_\-]{16,}["\047]'
  
  # Generic secrets
  'client[_-]?secret\s*[:=]\s*["\047][A-Za-z0-9_\-]{16,}["\047]'
  'encryption[_-]?key\s*[:=]\s*["\047][A-Za-z0-9_\-]{16,}["\047]'
)

# Get staged files (excluding certain file types)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx|js|jsx|json|yml|yaml|sh|py|rb|go|java|env|config|conf)$' | grep -v -E '(\.min\.|\.lock|package-lock\.json|yarn\.lock)' || true)

if [ -n "$STAGED_FILES" ]; then
  FOUND_SECRETS=false
  
  for pattern in "${SECRET_PATTERNS[@]}"; do
    # Check staged content (not just filenames)
    MATCHES=$(echo "$STAGED_FILES" | xargs git diff --cached -- 2>/dev/null | grep -iE "$pattern" | grep -v -E '^\s*(//|#|\*|<!--|/\*)' | grep -v 'process\.env\.' | grep -v '\$\{' | grep -v 'getenv' | grep -v 'os\.environ' | head -5)
    
    if [ -n "$MATCHES" ]; then
      if [ "$FOUND_SECRETS" = false ]; then
        echo ""
        echo "‚ö†Ô∏è  Potential secrets detected in staged changes:"
        echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        FOUND_SECRETS=true
      fi
      echo "$MATCHES" | head -3
      echo ""
    fi
  done
  
  if [ "$FOUND_SECRETS" = true ]; then
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    echo ""
    echo "Please review the above matches. If they are false positives:"
    echo "  - Use environment variables instead of hardcoding"
    echo "  - Add exclusion comments where appropriate"
    echo "  - Bypass with: git commit --no-verify (use sparingly)"
    echo ""
    # Warning only - don't block for pattern-based detection
    # Gitleaks is the authoritative check
  fi
fi

# -----------------------------------------------------------------------------
# 4. CHECK FOR .env FILES
# -----------------------------------------------------------------------------
echo "üìÑ Checking for .env files..."

ENV_FILES=$(git diff --cached --name-only | grep -E '^\.(env|env\..+)$' | grep -v '\.example$' || true)

if [ -n "$ENV_FILES" ]; then
  echo ""
  echo "‚ùå ERROR: Attempting to commit .env file(s)!"
  echo ""
  for file in $ENV_FILES; do
    echo "   - $file"
  done
  echo ""
  echo "Remove .env files from staging:"
  echo "   git reset HEAD <file>"
  echo ""
  echo ".env.example is allowed, but never commit actual .env files."
  exit 1
fi

# -----------------------------------------------------------------------------
# 5. CHECK FOR CONSOLE.LOG IN PRODUCTION CODE
# -----------------------------------------------------------------------------
echo "üñ•Ô∏è  Checking for console.log statements..."

# Only check TypeScript/JavaScript files in services (not tests)
CONSOLE_FILES=$(echo "$STAGED_FILES" | grep -E 'services/.*\.(ts|js)$' | grep -v '\.spec\.' | grep -v '\.test\.' | grep -v '__tests__' || true)

if [ -n "$CONSOLE_FILES" ]; then
  CONSOLE_LOGS=$(echo "$CONSOLE_FILES" | xargs git diff --cached -- 2>/dev/null | grep -E '^\+.*console\.(log|debug|info)\(' | grep -v 'import\.meta\.env\.DEV' | grep -v 'process\.env\.NODE_ENV' | head -5)
  
  if [ -n "$CONSOLE_LOGS" ]; then
    echo ""
    echo "‚ö†Ô∏è  Warning: New console.log statements detected in backend services:"
    echo "$CONSOLE_LOGS"
    echo ""
    echo "Consider:"
    echo "  - Removing debug logs before commit"
    echo "  - Using a proper logger (e.g., @nestjs/common Logger)"
    echo "  - Wrapping with: if (process.env.NODE_ENV === 'development')"
    echo ""
    # Warning only, don't block
  fi
fi

# -----------------------------------------------------------------------------
# 6. CHECK FOR DEBUG FLAGS
# -----------------------------------------------------------------------------
echo "üêõ Checking for debug flags..."

DEBUG_PATTERNS=$(echo "$STAGED_FILES" | xargs git diff --cached -- 2>/dev/null | grep -E '^\+.*(DEBUG\s*=\s*true|debug:\s*true|skipAuth:\s*true|bypassAuth|disableSecurity)' | head -5)

if [ -n "$DEBUG_PATTERNS" ]; then
  echo ""
  echo "‚ö†Ô∏è  Warning: Debug/bypass flags detected in changes:"
  echo "$DEBUG_PATTERNS"
  echo ""
  echo "Ensure these are not committed to production branches."
  # Warning only
fi

# -----------------------------------------------------------------------------
# 7. CHECK LARGE FILES
# -----------------------------------------------------------------------------
echo "üì¶ Checking for large files..."

LARGE_FILES=""
for file in $(git diff --cached --name-only --diff-filter=ACMR); do
  if [ -f "$file" ]; then
    SIZE=$(wc -c < "$file" 2>/dev/null || echo 0)
    if [ "$SIZE" -gt 5000000 ]; then  # 5MB
      LARGE_FILES="$LARGE_FILES\n   - $file ($(echo "scale=1; $SIZE/1000000" | bc)MB)"
    fi
  fi
done

if [ -n "$LARGE_FILES" ]; then
  echo ""
  echo "‚ö†Ô∏è  Warning: Large files detected (>5MB):"
  echo -e "$LARGE_FILES"
  echo ""
  echo "Consider using Git LFS for large binary files."
fi

# -----------------------------------------------------------------------------
# DONE
# -----------------------------------------------------------------------------
echo ""
echo "‚úÖ Pre-commit checks passed!"
echo ""
